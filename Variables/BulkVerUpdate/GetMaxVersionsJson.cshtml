@inherits avt.MyTokens.Core.ParsingEngine.RazorTemplate
@using Newtonsoft.Json

@{
    System.Diagnostics.Debugger.Launch();

    var allBranches = GetAllVersions();

    var maxVersions = allBranches.GroupBy(item => item.branch).Select(branch => new BranchVersions {
        branch = branch.Key,
        branchVersion = branch.Max(i => i.branchVersion)
    });

    var result = JsonConvert.SerializeObject(maxVersions);
}
@result

@functions {

    class BranchVersions {
        public int projectId { get; set; }

        public string branch { get; set; }

        public Version branchVersion { get; set; }
    }

    List<BranchVersions> GetAllVersions() {
        var results = new List<BranchVersions>();
        foreach (var row in Tokens.BulkVerUpdate.DbGetVersions()) {
            results.Add(new BranchVersions {
                projectId = int.Parse(row.ProjectId.ToString()),
                branch = row.Branch.ToString(),
                branchVersion = Version.Parse(row.BranchVersion.ToString())
            });
        }
        return results;
    }
}